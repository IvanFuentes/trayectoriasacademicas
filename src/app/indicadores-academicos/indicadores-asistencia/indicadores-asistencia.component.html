<div class="indicadores-asistencia-container">
  <div class="header">
    <h2>Indicadores de Asistencia</h2>
    <p class="subtitle">Visualización de seguimiento de asistencias por carrera y asignatura</p>
  </div>

  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <div *ngIf="!isLoading">
    <div class="general-section">
      <div class="general-header">
        <h3>Indicadores Generales de Asistencia de la Institución</h3>
        <p class="general-subtitle">Visualización consolidada de todos los programas educativos</p>
      </div>

      <div class="charts-row-general">
        <div class="chart-container-general">
          <h4 class="chart-title">Seguimiento del pase de lista</h4>
          <div class="chart-wrapper">
            <svg viewBox="0 0 100 100" class="pie-chart">
              <path
                *ngFor="let segment of getSeguimientoGeneralChartData(); let i = index"
                [attr.d]="getPieChartPath(getSeguimientoGeneralChartData(), i)"
                [attr.fill]="segment.color"
                class="pie-segment"
              ></path>
            </svg>
            <div class="chart-legend">
              <div class="legend-item" *ngFor="let segment of getSeguimientoGeneralChartData()">
                <span class="legend-color" [style.background-color]="segment.color"></span>
                <span class="legend-label">{{ segment.label }}</span>
                <span class="legend-value">{{ segment.porcentaje.toFixed(1) }}%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-container-general">
          <h4 class="chart-title">Balance general de asistencias</h4>
          <div class="chart-wrapper">
            <svg viewBox="0 0 100 100" class="pie-chart">
              <path
                *ngFor="let segment of getBalanceGeneralChartData(); let i = index"
                [attr.d]="getPieChartPath(getBalanceGeneralChartData(), i)"
                [attr.fill]="segment.color"
                class="pie-segment"
              ></path>
            </svg>
            <div class="chart-legend">
              <div class="legend-item" *ngFor="let segment of getBalanceGeneralChartData()">
                <span class="legend-color" [style.background-color]="segment.color"></span>
                <span class="legend-label">{{ segment.label }}</span>
                <span class="legend-value">{{ segment.porcentaje.toFixed(1) }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="carreras-section">
      <div class="carreras-header">
        <h3>Desglose por Carrera</h3>
        <p class="carreras-subtitle">Indicadores de asistencia por cada programa educativo</p>
      </div>

      <div class="carreras-container">
        <div class="carrera-card" *ngFor="let carrera of carreras">
          <div class="carrera-header" (click)="toggleCarrera(carrera)">
            <div class="carrera-info">
              <h3>{{ carrera.nombre }}</h3>
              <span class="estudiantes-count" *ngIf="carrera.expanded && carrera.asignaturas && carrera.asignaturas.length > 0">
                {{ carrera.asignaturas.length }} {{ carrera.asignaturas.length === 1 ? 'curso' : 'cursos' }}
              </span>
            </div>
            <button class="toggle-btn" [class.expanded]="carrera.expanded">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>

          <div class="carrera-content" *ngIf="carrera.expanded">
            <div *ngIf="carrera.loading" class="loading-indicator">
              <div class="spinner-small"></div>
              <p>Cargando datos de asistencia...</p>
            </div>

            <div *ngIf="carrera.error" class="error-message">
              <p>{{ carrera.error }}</p>
            </div>

            <div *ngIf="!carrera.loading && !carrera.error && carrera.sesiones">
              <div class="charts-row">
                <div class="chart-container">
                  <h4 class="chart-title">Seguimiento del pase de lista</h4>
                  <div class="chart-wrapper">
                    <svg viewBox="0 0 100 100" class="pie-chart">
                      <path
                        *ngFor="let segment of getSeguimientoChartData(carrera); let i = index"
                        [attr.d]="getPieChartPath(getSeguimientoChartData(carrera), i)"
                        [attr.fill]="segment.color"
                        class="pie-segment"
                      ></path>
                    </svg>
                    <div class="chart-legend">
                      <div class="legend-item" *ngFor="let segment of getSeguimientoChartData(carrera)">
                        <span class="legend-color" [style.background-color]="segment.color"></span>
                        <span class="legend-label">{{ segment.label }}</span>
                        <span class="legend-value">{{ segment.porcentaje.toFixed(1) }}%</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="chart-container">
                  <h4 class="chart-title">Balance general de asistencias</h4>
                  <div class="chart-wrapper">
                    <svg viewBox="0 0 100 100" class="pie-chart">
                      <path
                        *ngFor="let segment of getBalanceChartData(carrera); let i = index"
                        [attr.d]="getPieChartPath(getBalanceChartData(carrera), i)"
                        [attr.fill]="segment.color"
                        class="pie-segment"
                      ></path>
                    </svg>
                    <div class="chart-legend">
                      <div class="legend-item" *ngFor="let segment of getBalanceChartData(carrera)">
                        <span class="legend-color" [style.background-color]="segment.color"></span>
                        <span class="legend-label">{{ segment.label }}</span>
                        <span class="legend-value">{{ segment.porcentaje.toFixed(1) }}%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="asignaturas-section">
                <h4 class="section-title">Desglose por Asignatura</h4>

                <div class="asignatura-card" *ngFor="let asignatura of carrera.asignaturas">
                  <div class="asignatura-header" (click)="toggleAsignatura(asignatura)">
                    <div class="asignatura-info">
                      <h5 class="asignatura-nombre">{{ asignatura.nombre }}</h5>
                      <div class="asignatura-summary" *ngIf="!asignatura.expanded">
                        <span class="summary-item">Clave: {{ asignatura.clave }}</span>
                        <span class="summary-item">Grupo: {{ asignatura.grupo }}</span>
                        <span class="summary-item">Docente: {{ asignatura.docente }}</span>
                      </div>
                    </div>
                    <button class="toggle-btn-small" [class.expanded]="asignatura.expanded">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </button>
                  </div>

                  <div class="asignatura-details-expanded" *ngIf="asignatura.expanded">
                    <div class="asignatura-details">
                      <span class="detail-item">
                        <strong>Clave:</strong> {{ asignatura.clave }}
                      </span>
                      <span class="detail-item">
                        <strong>Grupo:</strong> {{ asignatura.grupo }}
                      </span>
                      <span class="detail-item">
                        <strong>Docente:</strong> {{ asignatura.docente }}
                      </span>
                      <span class="detail-item">
                        <strong>Estudiantes:</strong> {{ asignatura.totalEstudiantes }}
                      </span>
                      <span class="detail-item">
                        <strong>Total de Sesiones:</strong> {{ asignatura.totalSesiones }}
                      </span>
                    </div>

                    <div class="asignatura-chart">
                      <div class="mini-chart-wrapper">
                        <svg viewBox="0 0 100 100" class="pie-chart-small">
                          <path
                            *ngFor="let segment of getAsignaturaChartData(asignatura); let i = index"
                            [attr.d]="getPieChartPath(getAsignaturaChartData(asignatura), i)"
                            [attr.fill]="segment.color"
                            class="pie-segment"
                          ></path>
                        </svg>
                        <div class="mini-legend">
                          <div class="mini-legend-item" *ngFor="let segment of getAsignaturaChartData(asignatura)">
                            <span class="mini-legend-color" [style.background-color]="segment.color"></span>
                            <span class="mini-legend-text">
                              {{ segment.label }}: {{ segment.porcentaje.toFixed(1) }}%
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
