<div class="prevencion-container">
  <h2 class="section-title">Prevención y Atención Focalizada</h2>
  <p class="section-description">
    Identificación de estudiantes con faltas para intervención oportuna
  </p>

  <div class="legend-container">
    <div class="legend-item">
      <span class="legend-dot alerta"></span>
      <span class="legend-text">1-2 faltas (Alerta)</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot advertencia"></span>
      <span class="legend-text">3-4 faltas (Advertencia)</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot critico"></span>
      <span class="legend-text">5+ faltas (Crítico)</span>
    </div>
  </div>

  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

  <div *ngIf="isLoading" class="loading-message">
    Cargando carreras...
  </div>

  <div class="carreras-list" *ngIf="!isLoading">
    <div
      *ngFor="let carrera of carreras"
      class="carrera-item"
      [class.expanded]="selectedCarrera === carrera.id"
    >
      <button
        class="carrera-button"
        (click)="selectCarrera(carrera.id)"
      >
        <span class="carrera-nombre">{{ carrera.nombre }}</span>
        <span class="carrera-badge">{{ carrera.estudiantes.length }} estudiantes</span>
        <span class="carrera-icon">{{ selectedCarrera === carrera.id ? '−' : '+' }}</span>
      </button>

      <div class="estudiantes-container" *ngIf="selectedCarrera === carrera.id">
        <div *ngIf="carrera.loading" class="loading-message">
          Cargando estudiantes...
        </div>

        <div *ngIf="carrera.error" class="error-message">
          {{ carrera.error }}
        </div>

        <div
          *ngFor="let estudiante of carrera.estudiantes"
          class="estudiante-card"
          [class]="getFaltasClass(estudiante.diasFaltas)"
          (click)="openModal(estudiante)"
        >
          <div class="estudiante-info">
            <h3 class="estudiante-nombre">{{ estudiante.nombre }}</h3>
            <p class="estudiante-curso"><b>Matrícula:</b> {{ estudiante.matricula }}</p>
          </div>
          <div class="faltas-badge" [class]="getFaltasClass(estudiante.diasFaltas)">
            <span class="faltas-numero">{{ estudiante.diasFaltas }}</span>
            <span class="faltas-texto">faltas</span>
          </div>
        </div>

        <div *ngIf="!carrera.loading && !carrera.error && carrera.estudiantes.length === 0" class="empty-message">
          No hay estudiantes con faltas en esta carrera
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeModal()">×</button>

    <h2 class="modal-title">Información del Estudiante</h2>

    <div class="modal-body" *ngIf="selectedEstudiante">
      <div class="info-row">
        <span class="info-label">Nombre Completo:</span>
        <span class="info-value">{{ selectedEstudiante.nombre }}</span>
      </div>

      <div class="info-row">
        <span class="info-label">Matrícula:</span>
        <span class="info-value">{{ selectedEstudiante.matricula }}</span>
      </div>

      <div class="info-row">
        <span class="info-label">Correo Electrónico:</span>
        <span class="info-value">{{ selectedEstudiante.email }}</span>
      </div>

      <div class="info-row">
        <span class="info-label">Carrera:</span>
        <span class="info-value">{{ selectedEstudiante.carrera }}</span>
      </div>

      <div class="info-row highlight">
        <span class="info-label">Total de Faltas:</span>
        <span class="info-value faltas-count" [class]="getFaltasClass(selectedEstudiante.diasFaltas)">
          {{ selectedEstudiante.diasFaltas }}
        </span>
      </div>

      <div class="desglose-section">
        <h3 class="desglose-title">Desglose de Ausencias por Día</h3>
        <div class="desglose-lista">
          <details *ngFor="let dia of selectedEstudiante.desgloseDias" class="dia-item">
            <summary class="dia-header">
              <span class="dia-fecha">{{ dia.fecha }}</span>
              <span class="dia-count">{{ dia.cursos.length }} falta(s)</span>
            </summary>
            <div class="cursos-lista">
              <div *ngFor="let curso of dia.cursos" class="curso-item">
                <div class="curso-info">
                  <span class="curso-nombre">{{ curso.curso }}</span>
                  <span class="docente-nombre">Docente: {{ curso.docente }}</span>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>

      <button class="report-button" (click)="generarReporte()">
        Generar Reporte de Seguimiento
      </button>
    </div>
  </div>
</div>
